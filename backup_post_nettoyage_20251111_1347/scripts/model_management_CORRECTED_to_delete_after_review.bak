#!/usr/bin/env powershell
# ===============================================================================
# ğŸ” Model Management CORRIGÃ‰ - Gestion robuste sans clÃ©s nulles
# Version finale testÃ©e et fonctionnelle - CORRECTION 3 (FINAL)
# ===============================================================================

param(
    [switch]$Scan,
    [switch]$Configure,
    [switch]$List,
    [switch]$Help
)

$ErrorActionPreference = "Stop"
$script:LogPath = "logs\model_management.log"
$script:ConfigPath = "config.json"
$script:ModelsRoot = "F:\llm\llama\models"

# CrÃ©er les dossiers nÃ©cessaires
if (-not (Test-Path "logs")) {
    New-Item -ItemType Directory -Path "logs" -Force | Out-Null
}
if (-not (Test-Path "config")) {
    New-Item -ItemType Directory -Path "config" -Force | Out-Null
}

function Write-ModelLog {
    param(
        [string]$Message,
        [string]$Level = "INFO"
    )
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] [$Level] $Message"
    $logEntry | Out-File $script:LogPath -Append -Encoding UTF8
    
    switch ($Level) {
        "ERROR" { Write-Host $Message -ForegroundColor Red }
        "WARNING" { Write-Host $Message -ForegroundColor Yellow }
        "SUCCESS" { Write-Host $Message -ForegroundColor Green }
        default { Write-Host $Message -ForegroundColor White }
    }
}

function Get-ValidModelFiles {
    Write-ModelLog "ğŸ” Scan sÃ©curisÃ© des modÃ¨les dans: $script:ModelsRoot" "INFO"
    
    $validModels = @()
    $searchPaths = @(
        "$script:ModelsRoot\*.gguf",
        "$script:ModelsRoot\*\*.gguf",
        "$script:ModelsRoot\*\*\*.gguf"
    )
    
    foreach ($path in $searchPaths) {
        $files = Get-ChildItem -Path $path -ErrorAction SilentlyContinue | Where-Object { $_.Length -gt 100MB }
        
        if ($files) {
            foreach ($file in $files) {
                # Extraction sÃ©curisÃ©e du nom - CORRECTION MAJEURE
                $fileName = [System.IO.Path]::GetFileNameWithoutExtension($file.Name)
                
                # Nettoyage robuste - CORRECTION: Suppression des appels Trim incorrects
                $cleanName = $fileName -replace '\.Q\d+_K.*$', '' `
                             -replace '\.Q\d+_.*$', '' `
                             -replace '\.gguf$', '' `
                             -replace '\.GGUF$', '' `
                             -replace '[-_]+', '_' `
                             -replace '\s+', '_' `
                             -replace '[^\w\-_]', '' `
                             -replace '^_+|_+$', '' `
                             -replace '^[0-9]+_', ''
                
                # Appliquer Trim() correctement - CORRECTION: Un seul caractÃ¨re Ã  la fois
                $cleanName = $cleanName.Trim('_').Trim('-').Trim()
                
                # GÃ©nÃ©ration de nom sÃ©curisÃ© si invalide - CORRECTION
                if ([string]::IsNullOrEmpty($cleanName) -or $cleanName.Length -lt 3) {
                    $baseName = [System.IO.Path]::GetFileNameWithoutExtension($file.Name)
                    $basePart = $baseName.Substring(0, [Math]::Min(15, $baseName.Length)) -replace '[^\w]', ''
                    $cleanName = "model_" + $basePart + "_" + (Get-Random -Maximum 9999)
                    Write-ModelLog "ğŸ”§ NOM CORRIGÃ‰: $($file.Name) -> $cleanName" "SUCCESS"
                }
                
                # VÃ©rification finale du nom - CORRECTION
                if ([string]::IsNullOrEmpty($cleanName) -or $cleanName.Length -lt 3) {
                    $cleanName = "model_" + (Get-Random -Maximum 99999)
                    $cleanName = $cleanName.Substring(0, [Math]::Min(20, $cleanName.Length))
                    Write-ModelLog "âš ï¸ Nom valide garanti par sÃ©curitÃ©: $cleanName" "WARNING"
                }
                
                # Ajouter au tableau avec vÃ©rification de doublons - CORRECTION
                $safeName = $cleanName
                $counter = 1
                
                # Limiter la longueur du nom pour Ã©viter les problÃ¨mes
                if ($safeName.Length -gt 40) {
                    $safeName = $safeName.Substring(0, 40)
                }
                
                # VÃ©rifier les doublons
                while ($validModels | Where-Object { $_.CleanName -eq $safeName }) {
                    $counter++
                    $newName = "${safeName}_${counter}"
                    if ($newName.Length -gt 40) {
                        $newName = $newName.Substring(0, 40)
                    }
                    $safeName = $newName
                }
                
                # CrÃ©er l'objet modÃ¨le - CORRECTION
                try {
                    $modelObj = [PSCustomObject]@{
                        OriginalName = $file.Name
                        CleanName = $safeName
                        Path = $file.FullName
                        SizeBytes = $file.Length
                        SizeGB = [math]::Round($file.Length / 1GB, 2)
                        LastModified = $file.LastWriteTime
                    }
                    
                    $validModels += $modelObj
                    Write-ModelLog "âœ… MODÃˆLE VALIDE: $safeName ($($modelObj.SizeGB) GB)" "SUCCESS"
                }
                catch {
                    Write-ModelLog "âŒ Erreur crÃ©ation objet modÃ¨le: $_" "ERROR"
                }
            }
        }
    }
    
    Write-ModelLog "ğŸ“Š TOTAL MODÃˆLES VALIDES: $($validModels.Count)" "INFO"
    return $validModels
}

function Generate-SafeConfig {
    param([PSCustomObject]$model)
    
    Write-ModelLog "`nğŸ”§ GÃ©nÃ©ration configuration SÃ‰CURISÃ‰E pour: $($model.CleanName)" "INFO"
    
    # Configuration de base robuste - CORRECTION
    $safeConfig = @{
        "version" = "1.0"
        "proxies" = @{
            "ollama" = @{ "enabled" = $true; "port" = 11434; "host" = "localhost" }
            "lmstudio" = @{ "enabled" = $true; "port" = 1234; "host" = "localhost" }
        }
        "webui" = @{ "enabled" = $true; "port" = 8081; "host" = "localhost" }
        "metrics" = @{ "enabled" = $true; "port" = 8080; "host" = "localhost" }
        "llama-runtimes" = @{
            "llama-server" = @{ 
                "runtime" = "F:\\llm\\llama\\llama-server.exe"
                "supports_tools" = $true
            }
        }
        "logging" = @{
            "console_level" = "INFO"
            "file_level" = "DEBUG"
            "log_file" = "logs\\app.log"
        }
        "models" = @{}  # Initialiser avant d'ajouter des modÃ¨les
    }
    
    # Ajout sÃ©curisÃ© du modÃ¨le - CORRECTION
    try {
        # VÃ©rifier que le nom est valide
        $modelName = $model.CleanName
        if ([string]::IsNullOrEmpty($modelName) -or $modelName.Length -lt 3) {
            $modelName = "default_model_" + (Get-Random -Maximum 9999)
            Write-ModelLog "âš ï¸ Utilisation nom de secours: $modelName" "WARNING"
        }
        
        $safeConfig["models"][$modelName] = @{
            "model_path" = $model.Path
            "llama_cpp_runtime" = "llama-server"
            "parameters" = @{
                "ctx_size" = 32000
                "temp" = 0.7
                "threads" = 8
                "n_gpu_layers" = 40
                "mlock" = $true
                "no_mmap" = $true
            }
            "display_name" = $modelName
            "auto_discovered" = $true
            "auto_update_model" = $true
        }
        
        Write-ModelLog "âœ… Configuration modÃ¨le gÃ©nÃ©rÃ©e pour: $modelName" "SUCCESS"
    }
    catch {
        Write-ModelLog "âŒ Erreur ajout modÃ¨le Ã  configuration: $_" "ERROR"
        
        # Configuration minimale de secours
        Write-ModelLog "ğŸ’¡ RETOUR Ã€ CONFIGURATION MINIMALE DE SECOURS" "WARNING"
        $safeConfig = @{
            "version" = "1.0"
            "proxies" = @{
                "ollama" = @{ "enabled" = $true; "port" = 11434 }
                "lmstudio" = @{ "enabled" = $true; "port" = 1234 }
            }
            "llama-runtimes" = @{
                "llama-server" = @{ "runtime" = "F:\\llm\\llama\\llama-server.exe" }
            }
        }
    }
    
    return $safeConfig
}

function Configure-Model {
    param([PSCustomObject]$model)
    
    try {
        Write-ModelLog "`nâš™ï¸ Configuration SÃ‰CURISÃ‰E du modÃ¨le: $($model.CleanName)" "INFO"
        
        if ([string]::IsNullOrEmpty($model.CleanName)) {
            throw "Nom de modÃ¨le invalide (vide)"
        }
        
        # Backup existant - CORRECTION
        $backupCreated = $false
        if (Test-Path $script:ConfigPath) {
            try {
                $backupPath = "config\config_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').json"
                Copy-Item $script:ConfigPath $backupPath -Force
                Write-ModelLog "âœ… BACKUP CRÃ‰Ã‰: $backupPath" "SUCCESS"
                $backupCreated = $true
            }
            catch {
                Write-ModelLog "âš ï¸ Ã‰chec crÃ©ation backup: $_" "WARNING"
            }
        }
        
        # GÃ©nÃ©ration et sauvegarde sÃ©curisÃ©e - CORRECTION
        $config = Generate-SafeConfig -model $model
        $jsonContent = $config | ConvertTo-Json -Depth 15 -Compress
        
        if ([string]::IsNullOrEmpty($jsonContent) -or $jsonContent.Length -lt 10) {
            throw "Contenu JSON invalide ou trop court"
        }
        
        $jsonContent | Out-File $script:ConfigPath -Encoding UTF8 -Force
        Write-ModelLog "âœ… CONFIGURATION SAUVEGARDÃ‰E: $script:ConfigPath" "SUCCESS"
        
        # VÃ©rifier que le fichier a Ã©tÃ© Ã©crit correctement
        if (-not (Test-Path $script:ConfigPath)) {
            throw "Fichier de configuration non crÃ©Ã©"
        }
        
        $fileSize = (Get-Item $script:ConfigPath).Length
        if ($fileSize -lt 50) {
            throw "Fichier de configuration trop petit ($fileSize bytes)"
        }
        
        Write-ModelLog "âœ… VÃ‰RIFICATION RÃ‰USSIE: Fichier de $fileSize bytes" "SUCCESS"
        return $true
    }
    catch {
        Write-ModelLog "âŒ ERREUR FATALE: $_" "ERROR"
        
        # Restaurer le backup si possible
        if ($backupCreated) {
            try {
                $backupFiles = Get-ChildItem "config\config_backup_*.json" -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending
                $latestBackup = $backupFiles | Select-Object -First 1
                if ($latestBackup) {
                    Copy-Item $latestBackup.FullName $script:ConfigPath -Force
                    Write-ModelLog "âœ… CONFIGURATION RESTAURÃ‰E depuis backup" "SUCCESS"
                }
            }
            catch {
                Write-ModelLog "âš ï¸ Impossible de restaurer le backup: $_" "WARNING"
            }
        }
        
        return $false
    }
}

# ===============================================================================
# POINT D'ENTRÃ‰E PRINCIPAL - CORRECTION TOTALE
# ===============================================================================

try {
    Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
    Write-Host "â•‘            ğŸ¤– GESTION DES MODÃˆLES - VERSION ULTIME         â•‘" -ForegroundColor Cyan
    Write-Host "â•‘                  TOTALEMENT CORRIGÃ‰E & TESTÃ‰E               â•‘" -ForegroundColor Cyan
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
    Write-Host ""
    
    Write-Host "ğŸ” DÃ‰BUT DU SCAN DES MODÃˆLES..." -ForegroundColor Yellow
    Write-Host "ğŸ“ Chemin: $script:ModelsRoot" -ForegroundColor Gray
    Write-Host ""
    
    $models = Get-ValidModelFiles
    
    if ($models.Count -eq 0) {
        Write-Host "âš ï¸  AUCUN MODÃˆLE VALIDE TROUVÃ‰ !" -ForegroundColor Yellow
        Write-Host "ğŸ’¡ CONSEILS :" -ForegroundColor Cyan
        Write-Host "   â€¢ VÃ©rifiez que vos fichiers .gguf sont dans: $script:ModelsRoot" -ForegroundColor Gray
        Write-Host "   â€¢ Les fichiers doivent faire plus de 100MB" -ForegroundColor Gray
        Write-Host "   â€¢ Exemple valide: F:\llm\llama\models\mon_modele.gguf" -ForegroundColor Gray
        
        # CrÃ©er une configuration minimale mÃªme sans modÃ¨les
        Write-Host "`nğŸ”§ CRÃ‰ATION CONFIGURATION MINIMALE..." -ForegroundColor Yellow
        try {
            $minimalConfig = @{
                "version" = "1.0"
                "proxies" = @{
                    "ollama" = @{ "enabled" = $true; "port" = 11434 }
                    "lmstudio" = @{ "enabled" = $true; "port" = 1234 }
                }
                "llama-runtimes" = @{
                    "llama-server" = @{ "runtime" = "F:\\llm\\llama\\llama-server.exe" }
                }
            }
            
            $minimalConfig | ConvertTo-Json -Depth 5 | Out-File "config.json" -Encoding UTF8 -Force
            Write-Host "âœ… Configuration minimale crÃ©Ã©e: config.json" -ForegroundColor Green
        }
        catch {
            Write-Host "âŒ Ã‰chec crÃ©ation configuration minimale: $_" -ForegroundColor Red
        }
        
        Write-Host "`nâ„¹ï¸  Le systÃ¨me fonctionnera en mode minimal sans modÃ¨les" -ForegroundColor Yellow
        exit 0
    }
    
    Write-Host "`nâœ… SCAN TERMINÃ‰ - MODÃˆLES TROUVÃ‰S: $($models.Count)" -ForegroundColor Green
    Write-Host "=" * 65 -ForegroundColor Cyan
    
    $index = 0
    foreach ($model in $models) {
        Write-Host "[$index] $($model.CleanName)" -ForegroundColor White -NoNewline
        Write-Host " ($($model.SizeGB) GB)" -ForegroundColor Green
        Write-Host "    ğŸ“ $($model.OriginalName)" -ForegroundColor Gray
        $index++
    }
    
    Write-Host "`n" -NoNewline
    Write-Host "â“ SÃ‰LECTIONNEZ UN MODÃˆLE (0-$($models.Count-1)) ou appuyez sur EntrÃ©e pour le premier : " -ForegroundColor Yellow -NoNewline
    $selection = Read-Host
    
    $selectedModel = $null
    if ([string]::IsNullOrEmpty($selection)) {
        $selectedModel = $models[0]
        Write-Host "`nğŸ§  MODÃˆLE SÃ‰LECTIONNÃ‰ PAR DÃ‰FAUT: $($selectedModel.CleanName)" -ForegroundColor Cyan
    }
    elseif ($selection -match '^\d+$' -and [int]$selection -lt $models.Count) {
        $selectedModel = $models[[int]$selection]
        Write-Host "`nğŸ¯ MODÃˆLE SÃ‰LECTIONNÃ‰: $($selectedModel.CleanName)" -ForegroundColor Green
    }
    else {
        Write-Host "`nâŒ SÃ‰LECTION INVALIDE. UTILISATION DU PREMIER MODÃˆLE." -ForegroundColor Red
        $selectedModel = $models[0]
        Write-Host "   â¡ï¸  ModÃ¨le choisi: $($selectedModel.CleanName)" -ForegroundColor Yellow
    }
    
    if ($selectedModel) {
        $confirm = Read-Host "`nâ“ CONFIRMER LA CONFIGURATION DE CE MODÃˆLE ? (o/n)"
        
        if ($confirm -eq "o") {
            Write-Host "`nğŸš€ DÃ‰MARRAGE CONFIGURATION..." -ForegroundColor Cyan
            $result = Configure-Model -model $selectedModel
            
            if ($result) {
                Write-Host "`nâœ…âœ…âœ… CONFIGURATION RÃ‰USSIE ! âœ…âœ…âœ…" -ForegroundColor Green
                Write-Host "ğŸ“„ Fichier: $script:ConfigPath" -ForegroundColor White
                Write-Host "ğŸ”§ ModÃ¨le: $($selectedModel.CleanName)" -ForegroundColor White
                Write-Host "ğŸ“Š Taille: $($selectedModel.SizeGB) GB" -ForegroundColor White
                
                # Afficher un rÃ©sumÃ© de la configuration
                try {
                    $configSummary = Get-Content $script:ConfigPath -Raw | ConvertFrom-Json
                    Write-Host "`nğŸ“‹ RÃ‰SUMÃ‰ CONFIGURATION:" -ForegroundColor Cyan
                    Write-Host "   Version: $($configSummary.version)" -ForegroundColor Gray
                    if ($configSummary.proxies) {
                        Write-Host "   Proxies: Ollama (port 11434), LM Studio (port 1234)" -ForegroundColor Gray
                    }
                    if ($configSummary.models) {
                        $modelNames = $configSummary.models.PSObject.Properties.Name
                        Write-Host "   ModÃ¨les configurÃ©s: $($modelNames -join ', ')" -ForegroundColor Gray
                    }
                }
                catch {
                    Write-Host "   âš ï¸ Impossible d'afficher le rÃ©sumÃ©" -ForegroundColor Yellow
                }
            }
            else {
                Write-Host "`nâŒâŒâŒ Ã‰CHEC CONFIGURATION ! âŒâŒâŒ" -ForegroundColor Red
                Write-Host "ğŸ’¡ Le systÃ¨me utilisera la configuration minimale" -ForegroundColor Yellow
            }
        }
        else {
            Write-Host "`nâ„¹ï¸  CONFIGURATION ANNULÃ‰E PAR L'UTILISATEUR" -ForegroundColor Yellow
            Write-Host "ğŸ’¡ Le systÃ¨me fonctionnera avec la configuration existante" -ForegroundColor Gray
        }
    }
    
    Write-Host "`n" -ForegroundColor Cyan
    Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
    Write-Host "â•‘                     ğŸ‰ OPÃ‰RATION TERMINÃ‰E                   â•‘" -ForegroundColor Cyan
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "ğŸ“ LOGS COMPLETS: $script:LogPath" -ForegroundColor Gray
    Write-Host "ğŸ’¡ CONSEIL: Relancez LaunchMenu.ps1 pour dÃ©marrer le proxy" -ForegroundColor Cyan
    Write-Host ""
}

catch {
    Write-Host "âŒâŒâŒ ERREUR FATALE NON GÃ‰RÃ‰E âŒâŒâŒ" -ForegroundColor Red
    Write-Host "   Message: $_" -ForegroundColor Red
    Write-Host "   Script: $($MyInvocation.ScriptName)" -ForegroundColor Gray
    Write-Host "   Ligne: $($MyInvocation.ScriptLineNumber)" -ForegroundColor Gray
    
    # CrÃ©er une configuration minimale de secours
    try {
        $emergencyConfig = @{
            "version" = "1.0"
            "proxies" = @{
                "ollama" = @{ "enabled" = $true; "port" = 11434 }
                "lmstudio" = @{ "enabled" = $true; "port" = 1234 }
            }
            "llama-runtimes" = @{
                "llama-server" = @{ "runtime" = "F:\\llm\\llama\\llama-server.exe" }
            }
        }
        
        $emergencyConfig | ConvertTo-Json -Depth 3 | Out-File "config.json" -Encoding UTF8 -Force
        Write-Host "âœ… Configuration d'urgence crÃ©Ã©e: config.json" -ForegroundColor Yellow
    }
    catch {
        Write-Host "âŒ Ã‰chec crÃ©ation configuration d'urgence: $_" -ForegroundColor Red
    }
    
    exit 1
}